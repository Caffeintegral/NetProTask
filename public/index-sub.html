<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- <link href="../../NetProApp/public/canvas.css" rel="stylesheet" type="text/css">-->

    <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp({
            databaseURL: "https://netpro-3c4a0.firebaseio.com/",
        });
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>

    <title>チャットするページ</title>
    <style type="text/css">
        * {
            margin: 0px;
            padding: 0px;
        }

        body {}

        .title {
            padding: 10px;
        }

        .main {
            padding-left: 10px;
            margin: auto;
        }

        .toolbar {}

        .toolbar li {
            width: 44px;
            height: 44px;
            margin: auto;
            list-style-type: none;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin: 10px;
            display: block;
            float: left;
        }

        #black {
            background-color: black;
        }

        #red {
            background-color: red;
        }

        #green {
            background-color: green;
        }

        #blue {
            background-color: blue;
        }

        #small {
            text-align: center;
            line-height: 44px;
            font-size: 100%;
        }

        #middle {
            text-align: center;
            line-height: 44px;
            font-size: 200%;
        }

        #large {
            text-align: center;
            line-height: 44px;
            font-size: 300%;
        }

        .canvas {
            padding-left: 50px;
            width: 80%;
            height: 400px;
            border: 1px solid #ccc;
        }

        .canvas canvas {
            width: 600px;
            height: 400px;
        }

        div.chat {
            float: right;
            width: 40%;
        }

        div.canvasSide {
            float: left;
            width: 60%;
        }
    </style>
</head>

<body>
    <div id="app">
        <div>
            <div class="chat">
                <div>{{sender}}さん</div>
                <div>{{nowPlayer}}さんのターンです {{nowPlayerCounter}}</div>
                <label for="nameInput">メッセージ</label>
                <input type="txt" id="nameInput" v-model="message">


                <div>
                    <button @click="join">
                        参加する
                    </button>
                </div>
                <div>
                    <button @click="sendMessage">
                        送信
                    </button>
                </div>
                <div>
                    <button @click="nextUser">
                        ゲームを開始
                    </button>
                </div>
                <div>
                    <button :disabled="isCantPushButton" @click="nextUser">
                        <!-- :disabled="isCantPushButton" で　isCantPushButtonがtrueの時押せない -->
                        次の人へ
                    </button>
                </div>
                <div>
                    <button @click="removeMessage">
                        メッセージをすべて削除
                    </button>
                </div>

                <button :disabled="isCantPushButton" @click="test">自分のターンじゃないと押せない</button>

                <div>
                    <ul>
                        <li v-for="item in list">{{item.sender}} / {{item.message}}</li>
                    </ul>
                </div>

            </div>

            <!-- ここのタグの中にとりあえずキャンバスを実装して -->
            <div class="canvasSide">
                <div>
                    <div style="clear:left;"></div>
                    <div class="toolbar">
                        <ul>
                            <li id="black"> </li>
                            <li id="blue"></li>
                            <li id="red"></li>
                            <li id="green"></li>
                            <li id="small">S</li>
                            <li id="middle">M</li>
                            <li id="large">L</li>
                        </ul>
                    </div>
                </div>
                <div>
                    <div style="clear:left;"></div>
                    <div class="canvas">
                        <canvas id="myCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>
        new Vue({
            el: "#app",
            data: {
                list: [], //チャットの内容が入る
                sender: '名無し', //名前を入れて参加したときの名前
                nowPlayer: '未定', //○○さんのターンです　で表示される名前
                nowPlayerCounter: 0, //誰のターンなのか数値でカウントしてる
                isNowPlayer: false, // 今ターンか
                isCantPushButton: true, //ボタン押せるか
                message: '', // チャットの内容
                nameList: [], //参加者一覧の配列
                socketio: '', //そけっとあいおー
            },
            watch: {
                nowPlayer: {
                    handler: function (val, oldVal) { //nowPlayerの値が変更されたとき==ターンが移ったとき
                        this.nowPlayerFlag();
                    },
                    deep: true
                }
            },
            created() {
                this.socketio = io();
                this.getMessageFromDB();
                this.getNowPlayer();
                this.setNowPlayerCounter();
            },

            methods: {
                test() {
                    console.log("afo");
                },
                setNowPlayerCounter() {

                    firebase.database().ref('nowPlayerCounter/room1/').on('value', snapshot => {
                        console.log("PlayerList" + this.nameList);

                        if (snapshot) {
                            const rootList = snapshot.val();
                            var nowPlayerCounter = 0;
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayerCounter = (rootList[val]);
                            })
                            this.nowPlayerCounter = nowPlayerCounter;
                        }
                    })
                },

                turnCounter() {//ターンの計算　未定の時はスルーしないと0から始まれない
                    if (this.nowPlayer != '未定') {

                        this.nowPlayerCounter++;
                        if (this.nowPlayerCounter >= this.nameList.length) { //人数超えないように
                            this.nowPlayerCounter = 0;
                        }
                    }
                },

                getMessageFromDB() {//BDからメッセージを参照して代入
                    firebase.database().ref('messages/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let list = [];
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                list.push(rootList[val]);
                            })
                            this.list = list;
                        }
                    })

                },

                getNowPlayer() { //DBからnowPlayerを受け取る
                    firebase.database().ref('nowPlayer/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let nowPlayer = "未定";
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayer = rootList[val];
                            })
                            this.nowPlayer = nowPlayer;
                        }
                    })
                },

                nowPlayerFlag() { //今自分のターンなのかの判定
                    if (this.nowPlayer == this.sender) {
                        console.log("あなたのターンです");
                        this.isCantPushButton = false;
                        this.isNowPlayer = true;
                    } if (this.nowPlayer != this.sender) {
                        console.log(this.nowPlayer + "さんのターンです");
                        this.isCantPushButton = true;
                        this.isNowPlayer = false;
                    }
                },

                sendJoin(enterMessage) { //入室したとき　”入室しましたのメッセージを送る”
                    if (!this.sender || !enterMessage) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: enterMessage
                    })
                },


                //ボタン関連
                sendMessage() { //メッセージを送る（DBに）
                    if (!this.sender || !this.message) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: this.message
                    })
                    this.message = ''
                },

                join() { //参加ボタンを押したとき　名前入力させてDBに投げる
                    sender = window.prompt("ユーザー名を入力してください", "");
                    if (sender != "" && sender != null) {
                        this.sender = sender;
                        window.alert('ようこそ' + sender + 'さん');
                        this.socketio.emit("connected", sender);
                        this.sendJoin(sender + 'さんが参加しました．');

                        firebase.database().ref('users/room1/').on('value', snapshot => {
                            if (snapshot) {
                                const rootList = snapshot.val();
                                let nameList = [];
                                Object.keys(rootList).forEach((val, key) => {
                                    rootList[val].id = val;
                                    nameList.push(rootList[val].name);
                                })
                                this.nameList = nameList;
                            }
                        })
                    }
                    else if (sender != "" && sender != null) {
                        window.alert('名前を入力してください');
                    }
                    else {
                        window.alert('キャンセルされました');
                    }

                },

                removeMessage() { //メッセージ全削除（誰もいなくなったときとかに実行予定）
                    firebase.database().ref('messages/').set({ room1: "" });
                },

                nextUser() { //次へボタンを押したとき　DBに今誰のターンなのかを投げ，カウントも投げてる
                    this.turnCounter();

                    this.nowPlayer = this.nameList[this.nowPlayerCounter];

                    firebase.database().ref('nowPlayer/room1').set({
                        name: this.nowPlayer,
                        isNowPlayer: true
                    });

                    firebase.database().ref('nowPlayerCounter/room1').set({
                        count: this.nowPlayerCounter,
                    });
                }
            },
            mounted() {
                this.socketio.on("connected", function (sender) { //おまじない
                    console.log(sender);
                });
                this.socketio.on("disconnect", function () { });
                this.socketio.on("info", function () {
                });
            },
        })
    </script>
    <script type="text/javascript">
        window.addEventListener("load", function () {

            // サーバーサイドのsocket.IOに接続する
            // 接続出来たら、サーバー側のコンソールにconnected!と表示される
            var socket = io.connect("/");

            // Canvas描画に必要な変数を定義する
            var canvas = document.getElementById("myCanvas");
            var c = canvas.getContext("2d");
            var w = 650;
            var h = 400;
            var drawing = false;
            var oldPos;

            // Canvasを初期化する
            canvas.width = w;
            canvas.height = h;
            c.strokeStyle = "#000000";
            c.lineWidth = 5;
            c.lineJoin = "round";
            c.lineCap = "round";

            // Canvas上の座標を計算する為の関数たち
            function scrollX() {
                return document.documentElement.scrollLeft || document.body.scrollLeft;
            }
            function scrollY() {
                return document.documentElement.scrollTop || document.body.scrollTop;
            }
            function getPos(event) {
                var mouseX = event.clientX - $(canvas).position().left + scrollX();
                var mouseY = event.clientY - $(canvas).position().top + scrollY();
                return { x: mouseX, y: mouseY };
            }
            function getPosT(event) {
                var mouseX = event.touches[0].clientX - $(canvas).position().left + scrollX();
                var mouseY = event.touches[0].clientY - $(canvas).position().top + scrollY();
                return { x: mouseX, y: mouseY };
            }

            // ここからは、Canvasに描画する為の処理                             
            canvas.addEventListener("mousedown", function (event) {
                console.log("mousedown");
                drawing = true;
                oldPos = getPos(event);
            }, false);
            canvas.addEventListener("mouseup", function () {
                console.log("mouseup");
                drawing = false;
            }, false);
            canvas.addEventListener("mousemove", function (event) {
                var pos = getPos(event);
                console.log("mousemove : x=" + pos.x + ", y=" + pos.y + ", drawing=" + drawing);
                if (drawing) {
                    c.beginPath();
                    c.moveTo(oldPos.x, oldPos.y);
                    c.lineTo(pos.x, pos.y);
                    c.stroke();
                    c.closePath();

                    // socket.IOサーバーに、
                    // どの点からどの点までを描画するかをの情報を送付する
                    socket.emit("draw", { before: oldPos, after: pos });
                    oldPos = pos;
                }
            }, false);
            canvas.addEventListener("mouseout", function () {
                console.log("mouseout");
                drawing = false;
            }, false);

            // 色や太さを選択した場合の処理
            // 選択した結果を、Canvasに設定して、
            // socket.IOサーバーにも送付している
            $("#black").click(function () { c.strokeStyle = "black"; socket.emit("color", "black"); });
            $("#blue").click(function () { c.strokeStyle = "blue"; socket.emit("color", "blue"); });
            $("#red").click(function () { c.strokeStyle = "red"; socket.emit("color", "red"); });
            $("#green").click(function () { c.strokeStyle = "green"; socket.emit("color", "green"); });
            $("#small").click(function () { c.lineWidth = 5; socket.emit("lineWidth", 5); });
            $("#middle").click(function () { c.lineWidth = 10; socket.emit("lineWidth", 10); });
            $("#large").click(function () { c.lineWidth = 20; socket.emit("lineWidth", 20); });

            // socket.IOサーバーから描画情報を受け取った場合の処理
            // 受け取った情報を元に、Canvasに描画を行う
            socket.on("draw", function (data) {
                console.log("on draw : " + data);
                c.beginPath();
                c.moveTo(data.before.x, data.before.y);
                c.lineTo(data.after.x, data.after.y);
                c.stroke();
                c.closePath();
            });

            // socket.IOサーバーから色情報を受け取った場合の処理
            // Canvasに色を設定している
            socket.on("color", function (data) {
                console.log("on color : " + data);
                c.strokeStyle = data;
            });


            // socket.IOサーバーから線の太さ情報を受け取った場合の処理
            // Canvasに線の太さを設定している
            socket.on("lineWidth", function (data) {
                console.log("on lineWidth : " + data);
                c.lineWidth = data;
            });


        }, false);


    </script>



    </script>






</body>

</html>