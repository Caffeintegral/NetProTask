<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp({
            databaseURL: "https://netpro-3c4a0.firebaseio.com/",
        });
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <title>チャットするページ</title>
</head>

<body>
    <div id="app">
        <div>{{sender}}さん</div>
        <div>{{nowPlayer}}さんのターンです {{nowPlayerCounter}}</div>
        <label for="nameInput">メッセージ</label>
        <input type="txt" id="nameInput" v-model="message">

        <div>
            <button @click="join">
                参加する
            </button>
        </div>
        <div>
            <button @click="sendMessage">
                送信
            </button>
        </div>
        <div>
            <button @click="nextUser">
                ゲームを開始
            </button>
        </div>
        <div>
            <button :disabled="isCantPushButton" @click="nextUser">
                <!-- :disabled="isCantPushButton" で　isCantPushButtonがtrueの時押せない -->
                次の人へ
            </button>
        </div>
        <div>
            <button @click="removeMessage">
                メッセージをすべて削除
            </button>
        </div>

        <button :disabled="isCantPushButton" @click="test">自分のターンじゃないと押せない</button>

        <div>
            <ul>
                <li v-for="item in list">{{item.sender}} / {{item.message}}</li>
            </ul>
        </div>

        <div>
            <!-- ここのタグの中にとりあえずキャンバスを実装して -->
        </div>



    </div>
    <script>
        new Vue({
            el: "#app",
            data: {
                list: [], //チャットの内容が入る
                sender: '名無し', //名前を入れて参加したときの名前
                nowPlayer: '未定', //○○さんのターンです　で表示される名前
                nowPlayerCounter: 0, //誰のターンなのか数値でカウントしてる
                isNowPlayer: false, // 今ターンか
                isCantPushButton: true, //ボタン押せるか
                message: '', // チャットの内容
                nameList: [], //参加者一覧の配列
                socketio: '', //そけっとあいおー
            },
            watch: {
                nowPlayer: {
                    handler: function (val, oldVal) { //nowPlayerの値が変更されたとき==ターンが移ったとき
                        this.nowPlayerFlag();
                    },
                    deep: true
                }
            },
            created() {
                this.socketio = io();
                this.getMessageFromDB();
                this.getNowPlayer();
                this.setNowPlayerCounter();
            },

            methods: {
                test() {
                    console.log("afo");
                },
                setNowPlayerCounter() {

                    firebase.database().ref('nowPlayerCounter/room1/').on('value', snapshot => {
                        console.log("PlayerList" + this.nameList);

                        if (snapshot) {
                            const rootList = snapshot.val();
                            var nowPlayerCounter = 0;
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayerCounter = (rootList[val]);
                            })
                            this.nowPlayerCounter = nowPlayerCounter;
                        }
                    })
                },

                turnCounter() {//ターンの計算　未定の時はスルーしないと0から始まれない
                    if (this.nowPlayer != '未定') {

                        this.nowPlayerCounter++;
                        if (this.nowPlayerCounter >= this.nameList.length) { //人数超えないように
                            this.nowPlayerCounter = 0;
                        }
                    }
                },

                getMessageFromDB() {//BDからメッセージを参照して代入
                    firebase.database().ref('messages/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let list = [];
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                list.push(rootList[val]);
                            })
                            this.list = list;
                        }
                    })

                },

                getNowPlayer() { //DBからnowPlayerを受け取る
                    firebase.database().ref('nowPlayer/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let nowPlayer = "未定";
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayer = rootList[val];
                            })
                            this.nowPlayer = nowPlayer;
                        }
                    })
                },

                nowPlayerFlag() { //今自分のターンなのかの判定
                    if (this.nowPlayer == this.sender) {
                        console.log("あなたのターンです");
                        this.isCantPushButton = false;
                        this.isNowPlayer = true;
                    } if (this.nowPlayer != this.sender) {
                        console.log(this.nowPlayer + "さんのターンです");
                        this.isCantPushButton = true;
                        this.isNowPlayer = false;
                    }
                },

                sendJoin(enterMessage) { //入室したとき　”入室しましたのメッセージを送る”
                    if (!this.sender || !enterMessage) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: enterMessage
                    })
                },


                //ボタン関連
                sendMessage() { //メッセージを送る（DBに）
                    if (!this.sender || !this.message) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: this.message
                    })
                    this.message = ''
                },

                join() { //参加ボタンを押したとき　名前入力させてDBに投げる
                    sender = window.prompt("ユーザー名を入力してください", "");
                    if (sender != "" && sender != null) {
                        this.sender = sender;
                        window.alert('ようこそ' + sender + 'さん');
                        this.socketio.emit("connected", sender);
                        this.sendJoin(sender + 'さんが参加しました．');

                        firebase.database().ref('users/room1/').on('value', snapshot => {
                            if (snapshot) {
                                const rootList = snapshot.val();
                                let nameList = [];
                                Object.keys(rootList).forEach((val, key) => {
                                    rootList[val].id = val;
                                    nameList.push(rootList[val].name);
                                })
                                this.nameList = nameList;
                            }
                        })
                    }
                    else if (sender != "" && sender != null) {

                        window.alert('名前を入力してください');
                    }

                    else {

                        window.alert('キャンセルされました');

                    }

                },

                removeMessage() { //メッセージ全削除（誰もいなくなったときとかに実行予定）
                    firebase.database().ref('messages/').set({ room1: "" });
                },

                nextUser() { //次へボタンを押したとき　DBに今誰のターンなのかを投げ，カウントも投げてる
                    this.turnCounter();

                    this.nowPlayer = this.nameList[this.nowPlayerCounter];

                    firebase.database().ref('nowPlayer/room1').set({
                        name: this.nowPlayer,
                        isNowPlayer: true
                    });

                    firebase.database().ref('nowPlayerCounter/room1').set({
                        count: this.nowPlayerCounter,
                    });
                }
            },
            mounted() {
                this.socketio.on("connected", function (sender) { //おまじない
                    console.log(sender);
                });
                this.socketio.on("disconnect", function () { });
                this.socketio.on("info", function () {
                });

            },
        })
    </script>


</body>

</html>