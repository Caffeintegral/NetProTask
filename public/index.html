<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp({
            databaseURL: "https://netpro-3c4a0.firebaseio.com/",
        });
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <title>チャットするページ</title>
</head>

<body>
    <div id="app">
        <div id="app">
            <div>{{sender}}さん</div>
            <div>{{nowPlayer}}さんのターンです {{nowPlayerCounter}}</div>
            <label for="nameInput">メッセージ</label>
            <input type="txt" id="nameInput" v-model="message">

            <div>
                <button type="button" class="btn btn-default" @click="join">
                    参加する
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-default" @click="sendMessage">
                    送信
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-default" @click="nextUser">
                    ゲームを開始
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-default" @click="nextUser">
                    次の人へ
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-default" @click="removeMessage">
                    メッセージをすべて削除
                </button>
            </div>

            <div><input type=text id='test' value='aaaaaaaaaaaaaaa'></div>

            <div>
                <ul>
                    <li v-for="item in list">{{item.sender}} / {{item.message}}</li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        // import io from 'socket.io-client'   
        new Vue({
            el: "#app",
            data: {
                list: [],
                sender: '名無し',
                nowPlayer: '未定',
                nowPlayerCounter: 0,
                isNowPlayer: false,
                message: '',
                playerList: [],
                nameList: [],
                // socketio: io.connect('http://localhost:3000'),
                socketio: '',
                targetElement: document.getElementById('test'),

            },
            watch: {
                nowPlayer: {
                    handler: function (val, oldVal) {
                        this.nowPlayerFlag();
                        this.setNowPlayerCounter();
                    },
                    deep: true
                }
            },
            created() {
                this.socketio = io();
                this.getMessageFromDB();
                this.getNowPlayer();
                // this.socketio.on("connected", function (sender) {
                //     console.log(sender);
                //  });
                // // this.socketio.on("publish", function (data) {
                // //     this.sendJoin("sender" + 'さんが参加しました．');
                // //     console.log("334");
                // // });
                // // firebase.database().ref('nowPlayer/room1').set({ name: '未定' });
                // this.socketio.on('getCount', function(num){
                //         console.log(num);
                //         this.nowPlayerCounter = num;
                //     });

                // this.socketio.on("getCount",(num) =>{
                //         console.log(num);
                //         this.nowPlayerCounter = num;
                // });
                
                // this.socketio.on("sendCount", function (data) {});

                // this.socketio.on("disconnect", function () { });

                // this.socketio.on("info", function () {

                // });

                // this.socketio.on("getUserList", function () { });

                // var targetElement = document.getElementById('test');
                // 入力可にする
                // targetElement.readOnly = false;
                // 入力不可にする

                this.targetElement.readOnly = true;




            },

            methods: {
                addMessage(msg) {
                    console.log("できてる");
                },


                handler: function handler(event) {
                    console.log('334');
                },

                setNowPlayerCounter() {
                    console.log("setNowPlayerCounter")
                    firebase.database().ref('nowPlayerCounter/room1/').on('value', snapshot => {
                        console.log(this.playerList);

                        if (snapshot) {
                            const rootList = snapshot.val();
                            let nowPlayerCounter = 0;
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayerCounter = (rootList[val]);

                            })
                            this.nowPlayerCounter = nowPlayerCounter;
                            console.log(this.nowPlayerCounter);
                        }
                    })
                     firebase.database().ref('nowPlayerCounter/room1').set({
                        count: this.nowPlayerCounter,
                    });
                },

                getMessageFromDB() {//BDからメッセージを参照して代入
                    firebase.database().ref('messages/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let list = [];
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                list.push(rootList[val]);
                            })
                            this.list = list;
                        }
                        console.log(this.list);
                    })
                    
                },

                getNowPlayer() {
                    firebase.database().ref('nowPlayer/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let nowPlayer = "未定";
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayer = rootList[val];
                                // console.log(nowPlayer);
                            })
                            this.nowPlayer = nowPlayer;
                        }
                        // console.log(this.nowPlayer);
                    })
                    

                    //     firebase.database().ref('nowPlayerCounter/room1/').on('value', snapshot => {
                    //     console.log(this.playerList);

                    //     if (snapshot) {
                    //         const rootList = snapshot.val();
                    //         let nowPlayerCounter = 0;
                    //         Object.keys(rootList).forEach((val, key) => {
                    //             rootList[val].id = val;
                    //             nowPlayerCounter = (rootList[val]);

                    //         })
                    //         this.nowPlayerCounter = nowPlayerCounter;
                    //         console.log(this.nowPlayerCounter);
                    //     }
                    // })
                    //  firebase.database().ref('nowPlayerCounter/room1').set({
                    //     count: this.nowPlayerCounter,
                    // });

                    
                    
                },

                nowPlayerFlag() {
                    if (this.nowPlayer == this.sender) {
                        console.log("あなたのターンです");
                        this.targetElement.readOnly = false;
                    } else {
                        console.log(this.nowPlayer + "さんのターンです");
                        this.targetElement.readOnly = true;
                    }
                },

                sendJoin(enterMessage) {
                    if (!this.sender || !enterMessage) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: enterMessage
                    })
                },


                //ボタン関連
                sendMessage() {
                    if (!this.sender || !this.message) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: this.message
                    })
                    this.message = ''
                },

                join() {
                    sender = window.prompt("ユーザー名を入力してください", "");
                    if (sender != "" && sender != null) {
                        this.sender = sender;
                        // userArray.push(sender);
                        window.alert('ようこそ' + sender + 'さん');
                        this.socketio.emit("connected", sender);
                        this.sendJoin(sender + 'さんが参加しました．');
                        // console.log(userArray);

                        firebase.database().ref('users/room1/').on('value', snapshot => {
                            if (snapshot) {
                                const rootList = snapshot.val();
                                let nameList = [];
                                let playerList = [];
                                Object.keys(rootList).forEach((val, key) => {
                                    rootList[val].id = val;
                                    nameList.push(rootList[val].name);
                                    playerList.push(rootList[val]);

                                })
                                this.nameList = nameList;
                                this.playerList = playerList;
                                console.log(this.playerList);
                            }
                        })
                    }
                    else if (sender != "" && sender != null) {

                        window.alert('名前を入力してください');
                    }

                    else {

                        window.alert('キャンセルされました');

                    }
                    console.log(this.sender);

                },

                removeMessage() {
                    firebase.database().ref('messages/').set({ room1: "" });

                },

                nextUser() {

                    // this.socketio.on("sendCount", function (data) {
                    //     this.nowPlayerCounter = data;
                    //     console.log(this.nowPlayerCounter);
                    // });

                    

                    // firebase.database().ref('users/room1/').on('value', snapshot => {

                    //     if (snapshot) {
                    //         const rootList = snapshot.val();
                    //         let nameList = [];
                    //         let playerList = [];
                    //         Object.keys(rootList).forEach((val, key) => {
                    //             rootList[val].id = val;
                    //             nameList.push(rootList[val]);
                    //             playerList.push(rootList[val]);

                    //         })
                    //         this.nameList = nameList;
                    //         this.playerList = playerList;
                    //         console.log(this.playerList);
                    //     }

                    // })

                    // firebase.database().ref('nowPlayerCounter/room1/').on('value', snapshot => {
                    //     console.log(this.playerList);

                    //     if (snapshot) {
                    //         const rootList = snapshot.val();
                    //         let nowPlayerCounter = 0;
                    //         Object.keys(rootList).forEach((val, key) => {
                    //             rootList[val].id = val;
                    //             nowPlayerCounter = (rootList[val]);

                    //         })
                    //         this.nowPlayerCounter = nowPlayerCounter;
                    //         console.log(this.nowPlayerCounter);
                    //     }

                   

                    // })
                     // firebase.database().ref('nowPlayerCounter/room1').set({
                    //     count: this.nowPlayerCounter,
                    // });
                    // this.nowPlayerCounter++;

                    // if (this.nowPlayerCounter >= this.playerList.length) {
                    //     this.nowPlayerCounter = 0;
                    // }
                    // this.socketio.emit("sendCount", this.nowPlayerCounter);


                    // this.socketio.emit("getCount", this.nowPlayerCounter);

                    // this.socketio.on('getCount', function(num){
                    //     console.log(num);
                    //     this.nowPlayerCounter = num;
                    // });
                    console.log(this.nowPlayerCounter);

                    this.nowPlayer = this.playerList[this.nowPlayerCounter].name;
                    // console.log(this.nowPlayer);

                    firebase.database().ref('nowPlayer/room1').set({
                        name: this.nowPlayer,
                        isNowPlayer: true
                    });

                    if (this.nowPlayerCounter > this.playerList.length) {
                        this.nowPlayerCounter = 0;
                    }

                    this.nowPlayerCounter++;




                    // if (this.nowPlayerCounter >= this.playerList.length) {
                    //     this.nowPlayerCounter = 0;
                    // }

                    





                }
            },
            mounted() {
                
                this.socketio.on("connected", function (sender) {
                    console.log(sender);
                 });
                // this.socketio.on("publish", function (data) {
                //     this.sendJoin("sender" + 'さんが参加しました．');
                //     console.log("334");
                // });
                // firebase.database().ref('nowPlayer/room1').set({ name: '未定' });
                // this.socketio.on('getCount', function(num){
                //         console.log(num);
                //         this.nowPlayerCounter = num;
                //     });

                
                
                // this.socketio.on("sendCount", function (data) {});
                // this.socketio.on("getCount",(num) =>{
                //     console.log(num);
                //         this.nowPlayerCounter = num;
                // });

                

                this.socketio.on("disconnect", function () { });

                this.socketio.on("info", function () {

                });

                setTimeout(() => {
                    this.isLoading = false
                    }, 1000)
                },

        })
    </script>


</body>

</html>