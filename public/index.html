<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- <link href="../../NetProApp/public/canvas.css" rel="stylesheet" type="text/css">-->

    <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp({
            databaseURL: "https://netpro-3c4a0.firebaseio.com/",
        });
    </script>
    <script src="/socket.io/socket.io.js"></script>

    <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script> -->

    <title>チャットするページ</title>

</head>

<body>
    <div id="app">
        <div class='area'>
            <div>
                <div class="chat">
                    <div>{{sender}}さん</div>
                    <!-- <div>{{nowPlayer}}さんのターンです {{nowPlayerCounter}}</div> -->
                    <label for="nameInput">メッセージ</label>
                    <input type="txt" id="nameInput" v-model="message">


                    <div>
                        <button @click="join">
                            参加する
                        </button>
                    </div>
                    <div>
                        <button @click="sendMessage">
                            送信
                        </button>
                    </div>
                    <div>
                        <button :disabled="isPlaying" @click="gameStart">
                            ゲームを開始
                        </button>
                    </div>
                    <!-- <div>
                        <button :disabled="isCantPushButton" @click="nextUser">
                            次の人へ
                        </button>
                    </div> -->
                    <div>
                        <button @click="removeMessage">
                            メッセージをすべて削除
                        </button>
                    </div>

                    <div>
                        <ul>
                            <li v-for="item in list">{{item.sender}} / {{item.message}}</li>
                        </ul>
                    </div>

                </div>

                <!-- ここのタグの中にとりあえずキャンバスを実装して -->
                <div class="canvasSide">
                    <div class="header">
                        <div>{{nowPlayer}}さんのターンです 答え{{beforeAnswer}}</div>
                    </div>

                    <div class="canvas">
                        <canvas id="myCanvas"></canvas>
                        <div class="toolbar">
                            <div class="colors">
                                <div class="color" id="black"></div>
                                <div class="color" id="red"></div>
                                <div class="color" id="blue"></div>
                                <div class="color" id="green"></div>
                                <div class="color" id="yellow"></div>
                                <div class="color" id="pink"></div>
                                <div class="color" id="orange"></div>
                                <div class="color" id="purple"></div>
                                <div class="color" id="skyblue"></div>
                                <div class="color" id="brown"></div>
                                <div class="color" id="silver"></div>
                                <div class="color" id="white"></div>

                            </div>
                            <div class="lines">
                                <div id="smallBox">
                                    <div id="small">

                                    </div>
                                </div>
                                <div id="middleBox">
                                    <div id="middle">

                                    </div>
                                </div>
                                <div id="largeBox">
                                    <div id="large">

                                    </div>
                                </div>
                            </div>
                            <div>
                                <input type="button" id="allDeleteButton" value="全消し">
                            </div>

                            <div>
                                <input type="txt" id="answer" :disabled="isCantPushButton" v-model="answer">
                            </div>
                            <div>
                                <button :disabled="isCantPushButton" @click="nextUser">
                                    送信
                                </button>
                            </div>
                        </div>
                        <div><img id="lastCanvas"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        new Vue({
            el: "#app",
            data: {
                list: [], //チャットの内容が入る
                sender: '名無し', //名前を入れて参加したときの名前
                nowPlayer: '未定', //○○さんのターンです　で表示される名前
                nowPlayerCounter: 0, //誰のターンなのか数値でカウントしてる
                isNowPlayer: false, // 今ターンか
                isCantPushButton: true, //ボタン押せるか
                isPlaying: true,
                message: '', // チャットの内容
                nameList: [], //参加者一覧の配列
                answer: '',
                beforeAnswer: '',
                socketio: '', //そけっとあいおー
                image: "",



            },
            watch: {
                nowPlayer: {
                    handler: function (val, oldVal) { //nowPlayerの値が変更されたとき==ターンが移ったとき
                        this.nowPlayerFlag();
                        this.getLastCanvas();
                        if (this.nowPlayer == '未定') {
                            document.getElementById("myCanvas").style.pointerEvents = "auto";
                            document.getElementById("allDeleteButton").disabled = "";
                        }


                    },
                    deep: true
                },
                // nameList: {
                //     handler: function (val, oldVal) {
                //         if (!isPlaying) {
                //             document.getElementById("myCanvas").style.pointerEvents = "auto";
                //             document.getElementById("allDeleteButton").disabled = "";
                //         }

                //     },
                //     deep: true
                // },
            },
            created() {
                this.socketio = io();
                this.getMessageFromDB();
                this.getNowPlayer();
                this.setNowPlayerCounter();


            },

            methods: {
                test() {
                    console.log("afo");
                },
                setNowPlayerCounter() {

                    firebase.database().ref('nowPlayerCounter/room1/').on('value', snapshot => {
                        console.log("PlayerList" + this.nameList);

                        if (snapshot) {
                            const rootList = snapshot.val();
                            var nowPlayerCounter = 0;
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayerCounter = (rootList[val]);
                            })
                            this.nowPlayerCounter = nowPlayerCounter;
                        }
                    })

                },

                turnCounter() {//ターンの計算　未定の時はスルーしないと0から始まれない
                    if (this.nowPlayer != '未定') {

                        this.nowPlayerCounter++;
                        if (this.nowPlayerCounter >= this.nameList.length) { //人数超えないように
                            this.nowPlayerCounter = 0;
                        }
                    }
                },

                getMessageFromDB() {//BDからメッセージを参照して代入
                    firebase.database().ref('messages/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let list = [];
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                list.push(rootList[val]);
                            })
                            this.list = list;
                        }
                    })
                    this.getLastCanvas();
                },

                getLastCanvas() {
                    firebase.database().ref('img/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let imgUrl = "";
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                imgUrl = rootList[val];
                            })
                            this.imgUrl = imgUrl;
                        }
                    })
                    document.getElementById("lastCanvas").src = this.imgUrl;

                },

                getNowPlayer() { //DBからnowPlayerを受け取る
                    firebase.database().ref('nowPlayer/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let nowPlayer = "未定";
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                nowPlayer = rootList[val];
                            })
                            this.nowPlayer = nowPlayer;
                        }
                    })
                    firebase.database().ref('beforeAnswer/room1/').on('value', snapshot => {
                        if (snapshot) {
                            const rootList = snapshot.val();
                            let beforeAnswer = "";
                            Object.keys(rootList).forEach((val, key) => {
                                rootList[val].id = val;
                                beforeAnswer = rootList[val];
                            })
                            this.beforeAnswer = beforeAnswer;
                        }
                    })
                },

                nowPlayerFlag() { //今自分のターンなのかの判定
                    this.isPlaying = true;
                    if (this.nowPlayer == this.sender) {
                        console.log("あなたのターンです");
                        this.isCantPushButton = false;
                        this.isNowPlayer = true;
                        document.getElementById("myCanvas").style.pointerEvents = "auto";
                        document.getElementById("allDeleteButton").disabled = "";

                    } if (this.nowPlayer != this.sender) {
                        console.log(this.nowPlayer + "さんのターンです");
                        this.isCantPushButton = true;
                        this.isNowPlayer = false;
                        document.getElementById("myCanvas").style.pointerEvents = "none";
                        document.getElementById("allDeleteButton").disabled = "disabled";
                    }
                },

                sendJoin(enterMessage) { //入室したとき　”入室しましたのメッセージを送る”
                    if (!this.sender || !enterMessage) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: enterMessage
                    })
                },


                //ボタン関連
                sendMessage() { //メッセージを送る（DBに）
                    if (!this.sender || !this.message) return
                    firebase.database().ref('messages/room1/').push({
                        sender: this.sender,
                        message: this.message
                    })
                    if (this.message == 'alldelete') {
                        this.removeMessage()
                    }
                    this.message = ''
                },

                join() { //参加ボタンを押したとき　名前入力させてDBに投げる
                    sender = window.prompt("ユーザー名を入力してください", "");
                    if (sender != "" && sender != null) {
                        this.sender = sender;
                        window.alert('ようこそ' + sender + 'さん');
                        this.socketio.emit("connected", sender);
                        this.sendJoin(sender + 'さんが参加しました．');

                        firebase.database().ref('users/room1/').on('value', snapshot => {
                            if (snapshot) {
                                const rootList = snapshot.val();
                                let nameList = [];
                                Object.keys(rootList).forEach((val, key) => {
                                    rootList[val].id = val;
                                    nameList.push(rootList[val].name);
                                })
                                this.nameList = nameList;
                            }
                        })
                    }
                    else if (sender != "" && sender != null) {
                        window.alert('名前を入力してください');
                    }
                    else {
                        window.alert('キャンセルされました');
                    }
                    this.isPlaying = false

                },

                removeMessage() { //メッセージ全削除（誰もいなくなったときとかに実行予定）
                    firebase.database().ref('messages/').set({ room1: "" });
                },

                nextUser() { //次へボタンを押したとき　DBに今誰のターンなのかを投げ，カウントも投げてる

                    if (this.beforeAnswer.slice(-1) == this.answer.slice(0, 1) || this.beforeAnswer == "") {
                        var img = document.getElementById("myCanvas").toDataURL();
                        console.log(img);
                        firebase.database().ref('img/room1').set({
                            imgUrl: img,
                        });
                        this.turnCounter();

                        this.nowPlayer = this.nameList[this.nowPlayerCounter];

                        firebase.database().ref('nowPlayer/room1').set({
                            name: this.nowPlayer,
                            isNowPlayer: true
                        });

                        firebase.database().ref('nowPlayerCounter/room1').set({
                            count: this.nowPlayerCounter,
                        });


                        this.beforeAnswer = this.answer
                        firebase.database().ref('beforeAnswer/room1/').set({
                            beforeAnswer: this.beforeAnswer
                        })

                        this.answer = '';
                    }
                },

                gameStart() { //次へボタンを押したとき　DBに今誰のターンなのかを投げ，カウントも投げてる

                    this.turnCounter();

                    this.nowPlayer = this.nameList[this.nowPlayerCounter];

                    firebase.database().ref('nowPlayer/room1').set({
                        name: this.nowPlayer,
                        isNowPlayer: true
                    });

                    firebase.database().ref('nowPlayerCounter/room1').set({
                        count: this.nowPlayerCounter,
                    });

                    firebase.database().ref('messages/room1/').push({
                        sender: 'システム',
                        message: 'ゲーム開始です！ 「しりとり」の「り」から！'
                    })
                },



            },
            mounted() {
                this.socketio.on("connected", function (sender) { //おまじない
                    console.log(sender);
                });
                this.socketio.on("disconnect", function () { });
                this.socketio.on("info", function () {
                });


            },
        })
    </script>
    <script type="text/javascript">
        window.addEventListener("load", function () {
            console.log('334')

            // サーバーサイドのsocket.IOに接続する
            // 接続出来たら、サーバー側のコンソールにconnected!と表示される
            var socket = io.connect("/");

            // Canvas描画に必要な変数を定義する
            var canvas = document.getElementById("myCanvas");
            var context = canvas.getContext("2d");
            var w = 650;
            var h = 400;
            var drawing = false;
            var oldPos;

            // Canvasを初期化する
            canvas.width = w;
            canvas.height = h;
            context.strokeStyle = "#000000";
            context.lineWidth = 5;
            context.lineJoin = "round";
            context.lineCap = "round";

            // Canvas上の座標を計算する為の関数たち
            function scrollX() {
                return document.documentElement.scrollLeft || document.body.scrollLeft;
            }
            function scrollY() {
                return document.documentElement.scrollTop || document.body.scrollTop;
            }
            function getPos(event) {
                var mouseX = event.clientX - $(canvas).position().left + scrollX();
                var mouseY = event.clientY - $(canvas).position().top + scrollY();
                return { x: mouseX, y: mouseY };
            }
            function getPosT(event) {
                var mouseX = event.touches[0].clientX - $(canvas).position().left + scrollX();
                var mouseY = event.touches[0].clientY - $(canvas).position().top + scrollY();
                return { x: mouseX, y: mouseY };
            }

            // ここからは、Canvasに描画する為の処理                             
            canvas.addEventListener("mousedown", function (event) {
                console.log("mousedown");
                drawing = true;
                oldPos = getPos(event);
            }, false);
            canvas.addEventListener("mouseup", function () {
                console.log("mouseup");
                drawing = false;
            }, false);
            canvas.addEventListener("mousemove", function (event) {
                var pos = getPos(event);
                console.log("mousemove : x=" + pos.x + ", y=" + pos.y + ", drawing=" + drawing);
                if (drawing) {
                    context.beginPath();
                    context.moveTo(oldPos.x, oldPos.y);
                    context.lineTo(pos.x, pos.y);
                    context.stroke();
                    context.closePath();

                    // socket.IOサーバーに、
                    // どの点からどの点までを描画するかをの情報を送付する
                    socket.emit("draw", { before: oldPos, after: pos, color: context.strokeStyle, line: context.lineWidth });
                    oldPos = pos;
                }
            }, false);
            canvas.addEventListener("mouseout", function () {
                // console.log("mouseout");
                drawing = false;
            }, false);

            // 色や太さを選択した場合の処理
            // 選択した結果を、Canvasに設定して、
            // socket.IOサーバーにも送付している
            $("#black").click(function () { context.strokeStyle = "black"; socket.emit("color", "black"); });
            $("#blue").click(function () { context.strokeStyle = "blue"; socket.emit("color", "blue"); });
            $("#red").click(function () { context.strokeStyle = "red"; socket.emit("color", "red"); });
            $("#green").click(function () { context.strokeStyle = "green"; socket.emit("color", "green"); });
            $("#yellow").click(function () { context.strokeStyle = "yellow"; socket.emit("color", "yellow"); });
            $("#pink").click(function () { context.strokeStyle = "pink"; socket.emit("color", "pink"); });
            $("#orange").click(function () { context.strokeStyle = "orange"; socket.emit("color", "orange"); });
            $("#purple").click(function () { context.strokeStyle = "purple"; socket.emit("color", "purple"); });
            $("#skyblue").click(function () { context.strokeStyle = "skyblue"; socket.emit("color", "skyblue"); });
            $("#brown").click(function () { context.strokeStyle = "brown"; socket.emit("color", "brown"); });
            $("#silver").click(function () { context.strokeStyle = "silver"; socket.emit("color", "silver"); });
            $("#white").click(function () { context.strokeStyle = "white"; socket.emit("color", "white"); });
            $("#smallBox").click(function () { context.lineWidth = 5; socket.emit("lineWidth", 5); });
            $("#middleBox").click(function () { context.lineWidth = 7; socket.emit("lineWidth", 7); });
            $("#largeBox").click(function () { context.lineWidth = 10; socket.emit("lineWidth", 10); });

            $("#allDeleteButton").click(function () {
                console.log("72");
                socket.emit('clearsend');
                context.clearRect(0, 0, w, h);
            });

            socket.on('firstsend', function (msg) {
                // console.log(msg);
                for (key in msg) {
                    // console.log(key);
                    context.strokeStyle = msg[key].color;
                    context.lineWidth = msg[key].line;
                    context.beginPath();
                    context.moveTo(msg[key].before.x, msg[key].before.y);
                    context.lineTo(msg[key].after.x, msg[key].after.y);
                    context.stroke();
                    context.closePath();
                }
            });
            // socket.IOサーバーから描画情報を受け取った場合の処理
            // 受け取った情報を元に、Canvasに描画を行う
            socket.on("draw", function (data) {
                console.log("on draw : " + data);
                context.beginPath();
                context.moveTo(data.before.x, data.before.y);
                context.lineTo(data.after.x, data.after.y);
                context.stroke();
                context.closePath();
            });

            // socket.IOサーバーから色情報を受け取った場合の処理
            // Canvasに色を設定している
            socket.on("color", function (data) {
                console.log("on color : " + data);
                context.strokeStyle = data;
            });

            socket.on("delete", function () {
                console.log("clearRect");
                context.clearRect(0, 0, w, h);
            });


            // socket.IOサーバーから線の太さ情報を受け取った場合の処理
            // Canvasに線の太さを設定している
            socket.on("lineWidth", function (data) {
                console.log("on lineWidth : " + data);
                context.lineWidth = data;
            });






        }, false);



    </script>

    <style scoped>
        * {
            margin: 0px;
            padding: 0px;
        }

        body {}

        .title {
            padding: 10px;
        }

        .main {
            padding-left: 10px;
            margin: auto;
        }

        .toolbar {}

        /* .toolbar li {
            width: 44px;
            height: 44px;
            margin: auto;
            list-style-type: none;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin: 10px;
            display: block;
            float: left;
        } */

        #black {
            background-color: black;
        }

        #red {
            background-color: red;
        }

        #green {
            background-color: green;
        }

        #blue {
            background-color: blue;
        }

        #yellow {
            background-color: yellow;
        }

        #pink {
            background-color: pink;
        }

        #orange {
            background-color: orange;
        }

        #purple {
            background-color: purple;
        }

        #skyblue {
            background-color: skyblue;
        }

        #brown {
            background-color: brown;
        }

        #white {
            background-color: white;
        }

        #silver {
            background-color: silver;
        }

        #small {
            text-align: center;
            line-height: 44px;
            font-size: 100%;
        }

        #middle {
            text-align: center;
            line-height: 44px;
            font-size: 200%;
        }

        #large {
            text-align: center;
            line-height: 44px;
            font-size: 300%;
        }

        #myCanvas {
            width: 650px;
            height: 400px;
            border: 1px solid #ccc;

        }

        #lastCanvas {
            border: solid 1px #ccc;
            width: 650px;
            height: 400px;

        }

        /* .canvas canvas {

            width: 650px;
            height: 400px;
        } */

        #area {
            text-align: center;
        }

        .chat {
            padding-top: 5%;
            float: right;
            width: 40%;
        }

        .canvasSide {
            padding-top: 5%;
            padding-left: 5%;
            float: left;
            width: 55%;
            /* margin: 0 auto; */
            text-align: left;
        }

        .canvas {
            float: left;
            /* margin: 0 10px; */
        }

        .toolbar {
            float: right;
            /* float: right; */
            /* width: 50%; */

        }

        .colors {

            width: 100px;
            /* background: #999; */
            display: flex;
            flex-wrap: wrap;
        }

        .color {
            width: 50%;
            box-sizing: border-box;
            /* width: 44px; */
            height: 44px;
            /* margin: auto; */
            list-style-type: none;
            border: 1px solid #ccc;
            border-radius: 6px;
            /* margin: 10px; */
            /* display: block; */
            /* float: right; */
        }

        .lines {
            padding-top: 10px;
        }

        #smallBox {
            width: 100%;
            height: 30px;
            border: 1px solid #ccc;
        }

        #middleBox {
            width: 100%;
            height: 30px;
            border: 1px solid #ccc;
        }

        #largeBox {
            width: 100%;
            height: 30px;
            border: 1px solid #ccc;
        }

        #small {
            width: 10px;
            height: 10px;
            border-radius: 10px 10px 10px 10px;
            background-color: black;
            margin-left: 45%;
            margin-top: 10px;
        }

        #middle {
            width: 14px;
            height: 14px;
            border-radius: 10px 10px 10px 10px;
            background-color: black;
            margin-left: 43.5%;
            margin-top: 8px;
        }

        #large {
            width: 20px;
            height: 20px;
            border-radius: 20px 20px 20px 20px;
            background-color: black;
            margin-left: 42%;
            margin-top: 5px;
        }
    </style>



    </script>






</body>

</html>